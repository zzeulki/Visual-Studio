<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Professor</title>
	<style>
		div{
			display: inline-block;
		}
		body{
			text-align: center;
		}
		img {

			width: 200;
			height: 200;
		}
	</style>
</head>

<body>
	<img src="media/logo.jpg" alt="교수님의 강의">
	<br>
	<div>
	<button id="start"><img src="media/start.jpg" alt="강의 시작" onclick="startRecord();"></button>
	<p>강의 시작</p>
	</div>
	<div>
	<button id="start"><img src="media/stop.jpg" alt="강의 종료" onclick="stopRecord();"></button>
	<p>강의 종료</p>
	</div>
	<script src="//www.WebRTC-Experiment.com/RecordRTC.js"></script>
	<script src="BinaryJS.js"></script>
	<script>
		var client = new BinaryClient('ws://127.0.0.1:3306');

		client.on('open', function () {
			// for the sake of this example let's put the stream in the window
			window.Stream = client.createStream();

		});

		var audioInput;
		var recorder;
		var context;
		var check = 1;

		function startRecord() {

			alert("전송시작");
			var buffer = [];

			var session = {
				audio: true,
				video: false
			};
			var recordRTC = null;
			navigator.getUserMedia(session, initializeRecorder, onError => function () {
				console.log("error");
			});

			function initializeRecorder(stream) {
				var audioContext = window.AudioContext;
				context = new audioContext();
				audioInput = context.createMediaStreamSource(stream);
				var bufferSize = 2048;
				
				// create a javascript node
				recorder = context.createScriptProcessor(bufferSize, 1, 1);
				
				//var recorder = new MediaRecorder(stream, {mimeType:'audio/webm'});
				// specify the processing function
				recorder.onaudioprocess = recorderProcess;
				//recorder.ondataavailable = recorderProcess;
				// connect stream to our recorder
				audioInput.connect(recorder);
				// connect our recorder to the previous destination
				recorder.connect(context.destination);
			}

			function convertFloat32ToInt16(buffer) {
				l = buffer.length;
				buf = new Int16Array(l);
				while (l--) {
					buf[l] = Math.min(1, buffer[l]) * 0x7FFF;
				}
				return buf.buffer;
			}

			function recorderProcess(e) {
				var left = e.inputBuffer.getChannelData(0);
				window.Stream.write(convertFloat32ToInt16(left));
			}



		}
		function stopRecord() {
			alert("전송종료");
			audioInput.disconnect();
			recorder.disconnect(context.destination);
		}
	</script>
</body>

</html>